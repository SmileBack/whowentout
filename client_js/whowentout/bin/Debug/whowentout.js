// whowentout.js
(function(){
Type.registerNamespace('whowentout');whowentout.JobRelay=function(pusherKey){this.$4=pusherKey;}
whowentout.JobRelay.prototype={$0:null,$1:null,$2:null,$3:false,$4:null,$5:function($p0){var $0=Date.get_now().toLocaleDateString()+' '+Date.get_now().toLocaleTimeString();console.log(String.format('{0} : {1}',$0,$p0));},$6:function(){if(this.$3){return;}this.$3=true;this.$0=new whowentout.lib.JobQueue();this.$0.add_jobStart(ss.Delegate.create(this,this.$A));this.$0.add_jobComplete(ss.Delegate.create(this,this.$9));this.$0.add_statusChanged(ss.Delegate.create(this,this.$8));this.$1=new PusherApi.PusherClient(this.$4);this.$1.get_connection().add_stateChange(ss.Delegate.create(this,this.$D));this.$5('pusher key = '+this.$4);this.$2=this.$1.subscribe('job_queue');this.$2.add_subscriptionSucceeded(ss.Delegate.create(this,this.$C));this.$2.add_subscriptionFailed(ss.Delegate.create(this,this.$B));this.$2.bind('new_job',ss.Delegate.create(this,this.$7));},$7:function($p0){var $0=$p0.url;var $1=new whowentout.SendRequestJob($0);this.$0.add($1);this.$5(String.format('queued job [{0} jobs]',this.$0.get_count()));console.log($p0);},$8:function($p0,$p1){this.$5(String.format('JOB QUEUE : {0} -> {1}',$p1.get_oldStatus(),$p1.get_newStatus()));},$9:function($p0,$p1){this.$5(String.format('job complete [{0} jobs]',this.$0.get_count()));},$A:function($p0,$p1){this.$5('job start');},$B:function($p0,$p1){this.$5('subscription failed');},$C:function($p0,$p1){this.$5('subscription succeeded');},$D:function($p0,$p1){this.$5(String.format('PUSHER : {0} -> {1}',$p1.get_previous(),$p1.get_current()));}}
whowentout.SendRequestJob=function(url){whowentout.SendRequestJob.initializeBase(this);this.$0=url;}
whowentout.SendRequestJob.prototype={$0:null,run:function(){return $.ajax(this.$0);}}
whowentout.ConsoleLogJob=function(message){whowentout.ConsoleLogJob.initializeBase(this);this.$0=message;}
whowentout.ConsoleLogJob.prototype={$0:null,run:function(){console.log(this.$0);return null;}}
whowentout.CountJob=function(name,n){whowentout.CountJob.initializeBase(this);this.$2=name;this.$0=n;this.$1=0;}
whowentout.CountJob.prototype={$0:0,$1:0,$2:null,run:function(){var $0=$.Deferred();var $1=0;$1=window.setInterval(ss.Delegate.create(this,function(){
console.log(String.format('{0}: {1}',this.$2,this.$1));console.log(String.format('cur = {0}, target = {1}',this.$1,this.$0));this.$1++;if(this.$1>this.$0){window.clearInterval($1);$0.resolve();}}),100);return $0;}}
Type.registerNamespace('PusherApi');PusherApi.ConnectionState=function(){};PusherApi.ConnectionState.prototype = {initialized:'initialized',connecting:'connecting',connected:'connected',unavailable:'unavailable',failed:'failed',disconnected:'disconnected'}
PusherApi.ConnectionState.registerEnum('PusherApi.ConnectionState',false);PusherApi.Channel=function(channelJs){this.$2=channelJs;this.$2.bind('pusher:subscription_succeeded',ss.Delegate.create(this,function($p1_0){
if(this.$0!=null){this.$0(this,ss.EventArgs.Empty);}}));this.$2.bind('pusher:subscription_failed',ss.Delegate.create(this,function($p1_0){
if(this.$1!=null){this.$1(this,ss.EventArgs.Empty);}}));}
PusherApi.Channel.prototype={add_subscriptionSucceeded:function(value){this.$0=ss.Delegate.combine(this.$0,value);},remove_subscriptionSucceeded:function(value){this.$0=ss.Delegate.remove(this.$0,value);},$0:null,add_subscriptionFailed:function(value){this.$1=ss.Delegate.combine(this.$1,value);},remove_subscriptionFailed:function(value){this.$1=ss.Delegate.remove(this.$1,value);},$1:null,$2:null,bind:function(eventName,handler){this.$2.bind(eventName,handler);},trigger:function(eventName,data){return this.$2.trigger(eventName,data);}}
PusherApi.Connection=function(connectionJs){this.$2=connectionJs;this.$2.bind('state_change',ss.Delegate.create(this,this.$3));}
PusherApi.Connection.prototype={add_stateChange:function(value){this.$0=ss.Delegate.combine(this.$0,value);},remove_stateChange:function(value){this.$0=ss.Delegate.remove(this.$0,value);},$0:null,add_connected:function(value){this.$1=ss.Delegate.combine(this.$1,value);},remove_connected:function(value){this.$1=ss.Delegate.remove(this.$1,value);},$1:null,$2:null,get_state:function(){return this.$4(this.$2.state);},$3:function($p0){var $0=this.$4($p0.current);var $1=this.$4($p0.previous);if(this.$1!=null&&$0==='connected'){this.$1(this,ss.EventArgs.Empty);}if(this.$0!=null){this.$0(this,new PusherApi.StateChangeEventArgs($1,$0));}},$4:function($p0){var $0=$p0;switch($0){case 'initialized':return 'initialized';case 'connecting':return 'connecting';case 'connected':return 'connected';case 'unavailable':return 'unavailable';case 'failed':return 'failed';case 'disconnected':return 'disconnected';default:throw new Error('Invalid state '+$0+'.');}}}
PusherApi.StateChangeEventArgs=function(previous,current){PusherApi.StateChangeEventArgs.initializeBase(this);this.set_previous(previous);this.set_current(current);}
PusherApi.StateChangeEventArgs.prototype={$1_0:null,get_previous:function(){return this.$1_0;},set_previous:function(value){this.$1_0=value;return value;},$1_1:null,get_current:function(){return this.$1_1;},set_current:function(value){this.$1_1=value;return value;}}
PusherApi.PusherClient=function(applicationKey){this.$1={};this.$0=new Pusher(applicationKey);this.set_connection(new PusherApi.Connection(this.$0.connection));}
PusherApi.PusherClient.prototype={$0:null,$2:null,get_connection:function(){return this.$2;},set_connection:function(value){this.$2=value;return value;},subscribe:function(channelName){console.log(String.format('subscribing to {0}',channelName));this.$0.subscribe(channelName);return this.$3(channelName);},unsubscribe:function(channelName){this.$0.unsubscribe(channelName);delete this.$1[channelName];},$3:function($p0){var $0=this.$0.channel($p0);if($0==null){return null;}if(!Object.keyExists(this.$1,$p0)){this.$1[$p0]=new PusherApi.Channel($0);}return this.$1[$p0];},get_item:function(channelName){return this.$3(channelName);}}
Type.registerNamespace('whowentout.lib');whowentout.lib.JobQueueStatus=function(){};whowentout.lib.JobQueueStatus.prototype = {idle:'idle',busy:'busy'}
whowentout.lib.JobQueueStatus.registerEnum('whowentout.lib.JobQueueStatus',false);whowentout.lib.Job=function(){}
whowentout.lib.JobQueue=function(){this.$3=[];this.$5='idle';}
whowentout.lib.JobQueue.prototype={add_jobStart:function(value){this.$0=ss.Delegate.combine(this.$0,value);},remove_jobStart:function(value){this.$0=ss.Delegate.remove(this.$0,value);},$0:null,add_jobComplete:function(value){this.$1=ss.Delegate.combine(this.$1,value);},remove_jobComplete:function(value){this.$1=ss.Delegate.remove(this.$1,value);},$1:null,add_statusChanged:function(value){this.$2=ss.Delegate.combine(this.$2,value);},remove_statusChanged:function(value){this.$2=ss.Delegate.remove(this.$2,value);},$2:null,$4:null,get_currentJob:function(){return this.$4;},get_count:function(){return this.$3.length;},get_status:function(){return this.$5;},set_status:function(value){if(this.$5!==value){var $0=this.$5;var $1=value;this.$5=$1;if(this.$2!=null){this.$2(this,new whowentout.lib.JobQueueStatusChangedEventArgs($0,$1));}}return value;},clear:function(){this.$3.clear();},add:function(job){this.$3.enqueue(job);this.run();},run:function(){if(this.get_status()==='busy'){return;}this.set_status('busy');this.$6();},$6:function(){if(!this.get_count()){this.set_status('idle');return;}this.$4=this.$3.dequeue();if(this.$0!=null){this.$0(this,new whowentout.lib.JobEventArgs(this.$4));}var $0=this.$4.run();if(this.$7($0)){var $1=$0;var $2=ss.Delegate.create(this,function(){
this.$4=null;if(this.$1!=null){this.$1(this,new whowentout.lib.JobEventArgs(this.$4));}window.setTimeout(ss.Delegate.create(this,this.$6),0);});$1.then($2,$2);}else{window.setTimeout(ss.Delegate.create(this,this.$6),0);}},$7:function($p0){return $p0!=null&&$p0.then!=null;}}
whowentout.lib.JobEventArgs=function(job){whowentout.lib.JobEventArgs.initializeBase(this);this.$1_0=job;}
whowentout.lib.JobEventArgs.prototype={$1_0:null,get_job:function(){return this.$1_0;}}
whowentout.lib.JobQueueStatusChangedEventArgs=function(oldStatus,newStatus){whowentout.lib.JobQueueStatusChangedEventArgs.initializeBase(this);this.$1_0=oldStatus;this.$1_1=newStatus;}
whowentout.lib.JobQueueStatusChangedEventArgs.prototype={$1_0:null,$1_1:null,get_oldStatus:function(){return this.$1_0;},get_newStatus:function(){return this.$1_1;}}
whowentout.JobRelay.registerClass('whowentout.JobRelay');whowentout.lib.Job.registerClass('whowentout.lib.Job');whowentout.SendRequestJob.registerClass('whowentout.SendRequestJob',whowentout.lib.Job);whowentout.ConsoleLogJob.registerClass('whowentout.ConsoleLogJob',whowentout.lib.Job);whowentout.CountJob.registerClass('whowentout.CountJob',whowentout.lib.Job);PusherApi.Channel.registerClass('PusherApi.Channel');PusherApi.Connection.registerClass('PusherApi.Connection');PusherApi.StateChangeEventArgs.registerClass('PusherApi.StateChangeEventArgs',ss.EventArgs);PusherApi.PusherClient.registerClass('PusherApi.PusherClient');whowentout.lib.JobQueue.registerClass('whowentout.lib.JobQueue');whowentout.lib.JobEventArgs.registerClass('whowentout.lib.JobEventArgs',ss.EventArgs);whowentout.lib.JobQueueStatusChangedEventArgs.registerClass('whowentout.lib.JobQueueStatusChangedEventArgs',ss.EventArgs);(function(){$(function(){
var $1_0=window.self.pusher_key;var $1_1=new whowentout.JobRelay($1_0);$1_1.$6();});})();
})();// This script was generated using Script# v0.7.4.0
